- name: Install Workstation
  hosts: all
  become: true
  tasks:
    - name: Enable the CodeReady Linux Builder repository
      become: true
      ansible.builtin.command: dnf config-manager --enable crb
      args:
        creates: /etc/yum.repos.d/rocky-crb.repo
    - name: add epel
      ansible.builtin.dnf:
        name: epel-release
        state: present
    - name: Install rpmfusion free
      ansible.builtin.dnf:
        name: 'https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-9.noarch.rpm'
        disable_gpg_check: true
        state: present
    - name: Install rpmfusion nonfree
      ansible.builtin.dnf:
        name: 'https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-9.noarch.rpm'
        disable_gpg_check: true
        state: present
    - name: Upgrade all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
    - name: Install the 'virtualization hypervisor' package group
      ansible.builtin.dnf:
        name: '@virtualization hypervisor'
        state: present
    - name: Install the 'virtualization tools' package group
      ansible.builtin.dnf:
        name: '@virtualization tools'
        state: present
    - name: groupupdate core
      ansible.builtin.dnf:
        name: '@core'
        state: latest
    - name: groupupdate core
      ansible.builtin.dnf:
        name: '@multimedia'
        state: present
    - name: groupupdate core
      ansible.builtin.dnf:
        name: '@multimedia'
        state: latest
    - name: Install Development Tools
      ansible.builtin.dnf:
        name: '@Development Tools'
        state: present
    - name: Install libvirt-devel (needed for vagrant-libvirt plugin)
      ansible.builtin.dnf:
        name: libvirt-devel
        state: present
    #Install Vagrant
    - name: Add Hashicorp repo
      ansible.builtin.yum_repository:
        name: hashicorp
        description: Hashicorp repo
        file: hashicorp
        baseurl: https://rpm.releases.hashicorp.com/RHEL/$releasever/$basearch/stable
        gpgcheck: yes
        gpgkey: https://rpm.releases.hashicorp.com/gpg
    - name: Install vagrant
      ansible.builtin.dnf:
        name: 'vagrant'
        state: present
    #Install Vagrant Plugins
    - name: add vagrant-libvirt plugin
      ansible.builtin.command: vagrant plugin install vagrant-libvirt
    - name: add vagrant-disksize plugin
      ansible.builtin.command: vagrant plugin install vagrant-disksize
    - name: add vagrant-hostmanager plugin
      ansible.builtin.command: vagrant plugin install vagrant-hostmanager
    - name: add vagrant-mutate plugin
      ansible.builtin.command: vagrant plugin install vagrant-mutate
    - name: add vagrant-scp plugin
      ansible.builtin.command: vagrant plugin install vagrant-scp

    #Install Mullvad vpn
    - name: Add Mullvad repo
      ansible.builtin.yum_repository:
        name: mullvad
        description: Mullvad VPN
        file: mullvad
        baseurl: https://repository.mullvad.net/rpm/stable/$basearch
        gpgcheck: yes
        gpgkey: https://repository.mullvad.net/rpm/mullvad-keyring.asc
    - name: Install Mullvad VPN
      ansible.builtin.dnf:
        name: 'mullvad-vpn'
        state: present

    #Add user to groups
    - name: Add the user 'wdundore' with a bash shell, appending the group 'libvirt' and 'vagrant' to the user's groups
      ansible.builtin.user:
        name: wdundore
        shell: /bin/bash
        groups: libvirt,vagrant
        append: yes

    #Set up NFS
    - name: nfs
      ansible.builtin.dnf:
        name: 'nfs-utils'
        state: latest
    - name: permit traffic in default zone for nfs service
      ansible.posix.firewalld:
        service: nfs
        permanent: true
        state: enabled
    - name: permit traffic in default zone for ssh service
      ansible.posix.firewalld:
        service: ssh
        permanent: true
        state: enabled
